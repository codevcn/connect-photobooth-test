import { TPlacedImage, TPosition, TTemplateFrame, TTemplateType } from '@/utils/types/global'
import { stylePlacedImageByTemplateType } from '@/configs/print-template/templates-helpers'
import { useEffect, useRef, useState } from 'react'
import { useZoomElement } from '@/hooks/element/use-zoom-element'
import { createPortal } from 'react-dom'
import { useEditAreaStore } from '@/stores/ui/edit-area.store'

type TPlacedImageProps = {
  placedImage: TPlacedImage
  templateType: TTemplateType
  frameIndex: TTemplateFrame['index']
  frame: TTemplateFrame
  childIndex?: number
  onImageLoad?: () => void
  displayZoomButton?: boolean
}

export const PlacedImage = ({
  placedImage,
  templateType,
  frameIndex,
  frame,
  childIndex,
  onImageLoad,
  displayZoomButton = false,
}: TPlacedImageProps) => {
  const { placementState } = placedImage
  const [zoom, setZoom] = useState<number>(1)
  const { containerRef: refForZoom, zoomButtonRef } = useZoomElement<HTMLImageElement>({
    currentZoom: zoom,
    setCurrentZoom: setZoom,
  })
  const imgRef = useRef<HTMLImageElement | null>(null)
  const scaleFactor = useEditAreaStore((state) => state.editAreaScaleValue)
  const dragStart = useRef<TPosition>({ x: 0, y: 0 })
  const isDragging = useRef<boolean>(false)
  const positionInFrameRef = useRef<TPosition>({ x: 0, y: 0 })
  const styleByTemplateType = stylePlacedImageByTemplateType(
    templateType,
    placedImage,
    frame,
    {},
    zoom
  )

  const handlePointerDown = (e: React.PointerEvent) => {
    isDragging.current = true
    dragStart.current = {
      x: e.clientX - positionInFrameRef.current.x,
      y: e.clientY - positionInFrameRef.current.y,
    }
    imgRef.current!.style.cursor = 'grabbing'
  }

  const handlePointerMove = (e: React.PointerEvent) => {
    if (!isDragging.current) return
    const element = imgRef.current
    const container = element?.closest<HTMLElement>('.NAME-template-frame')
    if (!element || !container) return

    const containerRect = container.getBoundingClientRect()
    const elementRect = element.getBoundingClientRect()

    let newX = e.clientX - dragStart.current.x
    let newY = e.clientY - dragStart.current.y

    // Giới hạn trong container
    const maxX = containerRect.width - elementRect.width
    const maxY = containerRect.height - elementRect.height

    newX = Math.max(0, Math.min(newX, maxX))
    newY = Math.max(0, Math.min(newY, maxY))

    element.style.top = `${newY}px`
    element.style.left = `${newX}px`
    element.style.bottom = 'auto'
    element.style.right = 'auto'
    positionInFrameRef.current = { x: newX, y: newY }
  }

  const handlePointerUp = () => {
    isDragging.current = false
    imgRef.current!.style.cursor = 'grab'
  }

  const handleDisplayingZoomButton = () => {
    for (const el of document.body.querySelectorAll<HTMLElement>(
      '.NAME-zoom-placed-image-btn-wrapper'
    )) {
      el.classList.add('hidden')
    }
    const img = imgRef.current
    if (!img) return
    const imgRect = img.getBoundingClientRect()
    if (!imgRect) return
    const zoomButton = zoomButtonRef.current
    if (!zoomButton) return
    const zoomBtnWrapper = zoomButton.parentElement
    if (!zoomBtnWrapper) return
    zoomBtnWrapper.classList.remove('hidden')
    updateZoomButtonWrapper(img, imgRect, zoomBtnWrapper)
  }

  const updateZoomButtonWrapper = (
    img: HTMLElement,
    imgRect: DOMRect,
    zoomBtnWrapper: HTMLElement
  ) => {
    const widthAfterScale = img.offsetWidth * zoom * scaleFactor
    const heightAfterScale = img.offsetHeight * zoom * scaleFactor
    zoomBtnWrapper.style.top = `${imgRect.top + imgRect.height / 2 - heightAfterScale / 2}px`
    zoomBtnWrapper.style.left = `${imgRect.left + imgRect.width / 2 - widthAfterScale / 2}px`
    zoomBtnWrapper.style.height = `${heightAfterScale}px`
    zoomBtnWrapper.style.width = `${widthAfterScale}px`
  }

  useEffect(() => {
    const img = imgRef.current
    if (!img) return
    const imgRect = img.getBoundingClientRect()
    if (!imgRect) return
    const zoomBtnWrapper = zoomButtonRef.current?.parentElement
    if (!zoomBtnWrapper) return
    updateZoomButtonWrapper(img, imgRect, zoomBtnWrapper)
  }, [zoom])

  useEffect(() => {
    const img = imgRef.current
    if (!img) return
    positionInFrameRef.current = {
      x: img.offsetLeft,
      y: img.offsetTop,
    }
  }, [placedImage.id])

  return (
    <div
      style={{
        ...styleByTemplateType,
      }}
      className={`${
        zoom !== 1 ? 'NAME-zoomed' : 'NAME-not-zoomed'
      } NAME-frame-placed-image-wrapper h-full w-full relative select-none`}
    >
      <img
        onClick={handleDisplayingZoomButton}
        onDragStart={(e) => e.preventDefault()}
        ref={(node) => {
          imgRef.current = node
          refForZoom.current = node
        }}
        src={placedImage.imgURL}
        alt="Ảnh photobooth của bạn"
        className="NAME-frame-placed-image h-full w-full absolute top-0 left-0 z-10 select-none"
        style={{
          objectFit: placementState.objectFit,
          willChange: 'transform',
        }}
        onLoad={(e) => onImageLoad?.()}
        onPointerDown={handlePointerDown}
        onPointerMove={handlePointerMove}
        onPointerUp={handlePointerUp}
        // data-placed-image-meta-data={JSON.stringify(
        //   typeToObject<TPlacedImageMetaData>({
        //     placedImageInitialSize:,
        //     frameInitialSize,
        //   })
        // )}
      />

      {displayZoomButton &&
        createPortal(
          <div className="NAME-zoom-placed-image-btn-wrapper hidden select-none fixed bg-transparent top-0 left-0 z-99 border-2 border-main-cl">
            <button
              ref={zoomButtonRef}
              onClick={(e) => e.stopPropagation()}
              className="absolute top-[calc(100%-9px)] left-[calc(100%+9px)] rotate-y-180"
            >
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="18"
                height="18"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                strokeWidth="3"
                strokeLinecap="round"
                strokeLinejoin="round"
                className="lucide lucide-scaling-icon lucide-scaling text-main-cl h-[18px] w-[18px] md:w-[22px] md:h-[22px]"
              >
                <path d="M12 3H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" />
                <path d="M14 15H9v-5" />
                <path d="M16 3h5v5" />
                <path d="M21 3 9 15" />
              </svg>
            </button>
          </div>,
          document.body
        )}
    </div>
  )
}
