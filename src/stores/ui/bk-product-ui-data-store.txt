import {
  TBaseProduct,
  TClientProductVariant,
  TPrintAreaInfo,
  TMockupAttatchedData,
  TMockupData,
} from '@/utils/types/global'
import { create } from 'zustand'
import { useLayoutStore } from './print-layout.store'
import { TPrintLayout } from '@/utils/types/print-layout'
import { generateUniqueId } from '@/utils/helpers'

type TProductUIDataStore = {
  pickedProduct: TBaseProduct | null
  pickedVariant: TClientProductVariant | null
  pickedSurface: TBaseProduct['printAreaList'][number] | null // print area info
  isAddingToCart: boolean
  cartCount: number
  mockupsAttachedData: TMockupAttatchedData[]
  allowedPrintedAreaChangeId: string | null
  lastestMockupId: TMockupData['id'] | null
  firstProduct: [TBaseProduct, TPrintAreaInfo, TPrintLayout, TClientProductVariant?] | null

  // Actions
  setFirstProduct: (
    product: TBaseProduct,
    printArea: TPrintAreaInfo,
    layout: TPrintLayout,
    initialVariant?: TClientProductVariant
  ) => void
  setLastestMockupId: (mockupId: TMockupData['id']) => void
  getLastestMockupId: () => TMockupData['id'] | null
  resetAllowedPrintedAreaChangeId: () => void
  addMockupAttachedData: (data: TMockupAttatchedData) => void
  updateMockupAttachedData: (
    mockupId: TMockupData['id'],
    data: Partial<TMockupAttatchedData>
  ) => void
  addMockupNote: (mockupId: TMockupData['id'], note: string) => void
  getMockupAttachedData: (mockupId: TMockupData['id']) => TMockupAttatchedData | undefined
  handlePickProduct: (
    prod: TBaseProduct,
    printArea: TPrintAreaInfo,
    initialVariant?: TClientProductVariant
  ) => void
  handlePickFirstProduct: (
    prod: TBaseProduct,
    printArea: TPrintAreaInfo,
    initialLayout: TPrintLayout,
    initialVariant?: TClientProductVariant
  ) => void
  handlePickVariant: (variant: TClientProductVariant) => void
  handlePickSurface: (
    variantId: TClientProductVariant['id'],
    surfaceId: TPrintAreaInfo['id']
  ) => void
  setIsAddingToCart: (isAdding: boolean) => void
  setCartCount: (count: number) => void
  // handlePickProductOnRestore: (
  //   product: TBaseProduct,
  //   initialTemplate: TPrintTemplate,
  //   initialVariant: TClientProductVariant,
  //   initialSurface: TPrintAreaInfo
  // ) => void
  handlePickProductOnRestore: (
    product: TBaseProduct,
    initialVariant: TClientProductVariant,
    initialSurface: TPrintAreaInfo
  ) => void
  resetData: (resetAll?: boolean) => void
}

export const useProductUIDataStore = create<TProductUIDataStore>((set, get) => ({
  pickedProduct: null, // dc khởi tạo từ products gallery, restore
  pickedVariant: null, // dc khởi tạo từ products gallery, restore
  pickedSurface: null, // dc khởi tạo từ products gallery, restore
  isAddingToCart: false,
  cartCount: 0,
  mockupsAttachedData: [],
  allowedPrintedAreaChangeId: null,
  lastestMockupId: null,
  firstProduct: null,

  setFirstProduct: (product, printArea, layout, initialVariant) => {
    set({ firstProduct: [product, printArea, layout, initialVariant] })
  },
  getLastestMockupId: () => {
    return get().lastestMockupId
  },
  setLastestMockupId: (mockupId) => {
    set({ lastestMockupId: mockupId })
  },
  resetAllowedPrintedAreaChangeId: () => {
    set({ allowedPrintedAreaChangeId: generateUniqueId() })
  },
  resetData: (resetAll = false) => {
    if (resetAll) {
      set({
        pickedProduct: null,
        pickedVariant: null,
        pickedSurface: null,
        isAddingToCart: false,
        cartCount: 0,
        mockupsAttachedData: [],
      })
    } else {
      set({
        pickedProduct: null,
        pickedVariant: null,
        pickedSurface: null,
        isAddingToCart: false,
        cartCount: 0,
      })
    }
  },

  getMockupAttachedData: (mockupId) => {
    return (get().mockupsAttachedData || []).find((data) => data.mockupId === mockupId)
  },

  addMockupAttachedData: (data) => {
    set({ mockupsAttachedData: [...get().mockupsAttachedData, data] })
  },

  updateMockupAttachedData: (mockupId, data) => {
    const attachedDataList = [...(get().mockupsAttachedData || [])]
    console.log('>>> [note] existingData:', attachedDataList)
    if (attachedDataList.length === 0) {
      set({ mockupsAttachedData: [{ mockupId, ...data }] })
    } else {
      set({
        mockupsAttachedData: attachedDataList.map((prev) => {
          if (prev.mockupId === mockupId) {
            return { ...prev, ...data }
          }
          return prev
        }),
      })
    }
  },

  addMockupNote: (mockupId, note) => {
    const existingData = get().getMockupAttachedData(mockupId)
    if (existingData) {
      get().updateMockupAttachedData(mockupId, { mockupNote: note })
    } else {
      get().addMockupAttachedData({
        mockupId,
        mockupNote: note,
      })
    }
  },

  setIsAddingToCart: (isAdding: boolean) => {
    set({ isAddingToCart: isAdding })
  },

  setCartCount: (count: number) => {
    set({ cartCount: count })
  },

  handlePickSurface: (variantId, surfaceId) => {
    const pickedProduct = get().pickedProduct
    if (!pickedProduct) return
    const surface = pickedProduct.printAreaList.find(
      (s) => s.id === surfaceId && s.variantId === variantId
    )
    if (surface) {
      set({ pickedSurface: surface })
    }
  },

  // handlePickProductOnRestore: (product, initialTemplate, initialVariant, initialSurface) => {
  //   set({
  //     pickedProduct: product,
  //     pickedVariant: initialVariant,
  //     pickedSurface: initialSurface,
  //   })
  //   useTemplateStore.getState().pickTemplateOnRestore(initialTemplate, initialSurface)
  // },
  handlePickProductOnRestore: (product, initialVariant, initialSurface) => {
    set({
      pickedProduct: product,
      pickedVariant: initialVariant,
      pickedSurface: initialSurface,
    })
  },

  handlePickProduct: (product, printArea, initialVariant) => {
    console.log('>>> [ppp] start:', { product, printArea })
    set({
      pickedProduct: product,
      pickedVariant: initialVariant || product.variants[0],
      pickedSurface: printArea,
    })
    // useTemplateStore.getState().pickTemplate(initialTemplate.id, printArea)
    // if (initialLayout) useLayoutStore.getState().pickLayout(initialLayout)
    // else useLayoutStore.getState().pickNoLayout()
  },

  handlePickFirstProduct: (product, printArea, initialLayout, initialVariant) => {
    useLayoutStore.getState().pickLayout(initialLayout)
    get().handlePickProduct(product, printArea, initialVariant)
  },

  handlePickVariant: (variant) => {
    const { pickedProduct, pickedSurface } = get()
    if (!pickedProduct || !pickedSurface) {
      return
    }

    // Tìm mockup tương ứng với variant + surface để lấy dynamic transform
    const mockup = pickedProduct.printAreaList.find(
      (vs) => vs.variantId === variant.id && vs.id === pickedSurface.id
    )

    // Nếu có transform động, cập nhật print area
    if (mockup && mockup.area && Object.keys(mockup.area).length > 0) {
      const { area } = mockup
      const updatedSurface: TPrintAreaInfo = {
        ...pickedSurface,
        area: {
          printX: area.printX || pickedSurface.area.printX,
          printY: area.printY || pickedSurface.area.printY,
          printW: area.printW || pickedSurface.area.printW,
          printH: area.printH || pickedSurface.area.printH,
          widthRealPx: area.widthRealPx || pickedSurface.area.widthRealPx,
          heightRealPx: area.heightRealPx || pickedSurface.area.heightRealPx,
          scale: area.scale || pickedSurface.area.scale,
        },
      }
      set({ pickedVariant: variant, pickedSurface: updatedSurface })
    } else {
      set({ pickedVariant: variant })
    }
  },
}))
